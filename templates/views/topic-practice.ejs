<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title><%= selectedRole %> | <%= topic.title %> Practice</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    /* Add these new styles */
    .permission-warning {
      background: linear-gradient(135deg, #ff6b35, #f7931e);
      color: white;
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
      border-left: 5px solid #ff0000;
      display: none;
    }
    
    .permission-warning a {
      color: #fff;
      text-decoration: underline;
      font-weight: bold;
    }

    .btn-voice:disabled {
      background: #6c757d !important;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .status-error {
      color: #dc3545 !important;
    }

    .status-success {
      color: #28a745 !important;
    }

    .status-warning {
      color: #ffc107 !important;
    }

    /* Your existing CSS styles remain the same */
    :root {
      --primary-blue: #1070AE;
      --deep-blue: #064471;
      --dark-blue: #05243B;
      --beige: #F3EDE1;
      --sky-blue: #439FC8;
      --white: #ffffff;
    }

    body {
      background: linear-gradient(135deg, var(--dark-blue) 0%, #0a3454 100%);
      font-family: 'Segoe UI', sans-serif;
      color: var(--white);
      min-height: 100vh;
      overflow-x: hidden;
    }

    .card-custom {
      background: linear-gradient(145deg, #0a2c49, #093052);
      border: 1px solid rgba(67, 159, 200, 0.2);
      border-radius: 16px;
      padding: 28px;
      margin-bottom: 25px;
      color: var(--white);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      opacity: 0;
      transform: translateY(30px);
      animation: fadeInUp 0.8s forwards;
    }

    .card-custom:nth-child(1) {
      animation-delay: 0.2s;
    }
    
    .card-custom:nth-child(2) {
      animation-delay: 0.4s;
    }

    .card-custom:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 25px rgba(0, 0, 0, 0.2);
      border-color: rgba(67, 159, 200, 0.4);
    }

    .section-title {
      color: var(--sky-blue);
      font-weight: 700;
      margin-bottom: 20px;
      font-size: 1.5rem;
      position: relative;
      display: inline-block;
    }

    .section-title::after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 0;
      width: 40px;
      height: 3px;
      background: var(--sky-blue);
      border-radius: 3px;
      transition: width 0.5s ease;
    }

    .card-custom:hover .section-title::after {
      width: 100%;
    }

    .text-center .section-title::after {
      left: 50%;
      transform: translateX(-50%);
    }

    .sample-question {
      background: linear-gradient(to right, rgba(6, 68, 113, 0.7), rgba(6, 68, 113, 0.9));
      color: white;
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
      border: 1px solid var(--sky-blue);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      transition: all 0.4s ease;
      opacity: 0;
      transform: translateX(-30px);
      position: relative;
      overflow: hidden;
    }

    .sample-question::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      transition: 0.5s;
    }

    .sample-question:hover::before {
      left: 100%;
    }

    .sample-question:hover {
      box-shadow: 0 0 20px rgba(67, 159, 200, 0.4);
      transform: translateY(-5px) translateX(0);
    }

    .sample-question:nth-child(even) {
      transform: translateX(30px);
    }

    .sample-question.visible {
      opacity: 1;
      transform: translateX(0) !important;
    }

    .question-number {
      display: inline-block;
      width: 32px;
      height: 32px;
      background: var(--primary-blue);
      color: white;
      border-radius: 50%;
      text-align: center;
      line-height: 32px;
      margin-right: 12px;
      font-weight: bold;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .btn-primary-custom {
      background: linear-gradient(to right, var(--primary-blue), var(--sky-blue));
      color: white;
      border: none;
      padding: 12px 28px;
      border-radius: 10px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 8px rgba(16, 112, 174, 0.3);
      position: relative;
      overflow: hidden;
    }

    .btn-primary-custom:hover {
      background: linear-gradient(to right, var(--sky-blue), var(--primary-blue));
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(16, 112, 174, 0.4);
    }

    .btn-primary-custom:after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: 0.5s;
    }

    .btn-primary-custom:hover:after {
      left: 100%;
    }

    .btn-outline-light {
      border: 2px solid var(--white);
      padding: 10px 26px;
      border-radius: 10px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-outline-light:hover {
      background-color: rgba(255, 255, 255, 0.1);
      transform: translateY(-2px);
    }

    /* Voice Recording Styles */
    .voice-controls {
      display: flex;
      gap: 10px;
      margin: 10px 0;
      align-items: center;
      flex-wrap: wrap;
    }

    .btn-voice {
      background: linear-gradient(to right, #28a745, #20c997);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      transition: all 0.3s ease;
      min-width: 140px;
    }

    .btn-voice.recording {
      background: linear-gradient(to right, #dc3545, #e35d6a);
      animation: pulse 1.5s infinite;
    }

    .btn-voice:hover:not(:disabled) {
      transform: translateY(-2px);
    }

    .btn-stop {
      background: linear-gradient(to right, #dc3545, #e35d6a);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      transition: all 0.3s ease;
      min-width: 140px;
    }

    .btn-stop:hover {
      transform: translateY(-2px);
    }

    .voice-status {
      font-size: 0.9rem;
      color: var(--sky-blue);
      padding: 8px 12px;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.05);
      min-width: 200px;
    }

    /* Feedback Styles */
    .feedback-box {
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      background: rgba(255, 255, 255, 0.1);
      border-left: 4px solid var(--sky-blue);
    }

    .feedback-good {
      border-left-color: #28a745;
      background: rgba(40, 167, 69, 0.1);
    }

    .feedback-average {
      border-left-color: #ffc107;
      background: rgba(255, 193, 7, 0.1);
    }

    .feedback-poor {
      border-left-color: #dc3545;
      background: rgba(220, 53, 69, 0.1);
    }

    /* Animations */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
      }
    }

    /* Rest of your existing CSS */
  </style>
</head>
<body>
  <!-- Floating background icons -->
  <i class="bi bi-chat-quote floating-icon floating-icon-1"></i>
  <i class="bi bi-patch-question floating-icon floating-icon-2"></i>

  <div class="container mt-4">
    <!-- Permission Warning -->
    <div id="permissionWarning" class="permission-warning">
      <i class="bi bi-exclamation-triangle-fill me-2"></i>
      <strong>Microphone Permission Required:</strong> 
      Voice recording needs microphone access. 
      <a href="#" onclick="showPermissionHelp()">Click here for help</a>
    </div>

    <!-- Page Header -->
    <div class="card-custom text-center mb-4">
      <span class="topic-badge"><%= topic.title %></span>
      <h3 class="mb-2"><%= selectedRole %> Practice</h3>
      <p class="mb-0 opacity-90"><%= topic.desc %></p>
    </div>

    <!-- Practice Questions -->
    <div class="card-custom">
      <h4 class="section-title"><i class="bi bi-question-circle me-2"></i>Practice Questions</h4>
      
      <% if (questions.length) { %>
        <div class="questions-container">
          <% questions.forEach((q, i) => { %>
            <div class="sample-question" data-delay="<%= i * 100 %>">
              <span class="question-number"><%= i+1 %></span>
              <span class="fw-bold">Question:</span>
              <p class="mt-2"><%= q.questionText %></p>
              
              <!-- Voice Controls -->
              <div class="voice-controls">
                <button class="btn btn-voice" onclick="startRecording('<%= q._id %>')" id="record-<%= q._id %>">
                  <i class="bi bi-mic me-1"></i> Start Recording
                </button>
                <button class="btn btn-stop" onclick="stopRecording('<%= q._id %>')" id="stop-<%= q._id %>" style="display: none;">
                  <i class="bi bi-square-fill me-1"></i> Stop Recording
                </button>
                <span class="voice-status" id="status-<%= q._id %>">
                  <i class="bi bi-info-circle me-1"></i>Click record to start speaking
                </span>
              </div>

              <!-- Manual Input Textarea -->
              <textarea id="answer-<%= q._id %>" class="form-control mt-2" rows="3" placeholder="Type your answer here or use voice recording..."></textarea>
              
              <!-- Action Buttons -->
              <div class="mt-3">
                <button class="btn btn-primary-custom me-2" onclick="tryYourself('<%= q._id %>')">
                  <i class="bi bi-pencil"></i> Check Answer
                </button>
                <button class="btn btn-outline-light" onclick="showSample('<%= q._id %>')">
                  <i class="bi bi-eye"></i> Show Sample Answer
                </button>
              </div>

              <!-- Enhanced Feedback Area -->
              <div id="feedback-<%= q._id %>" class="mt-2"></div>
              
              <!-- Detailed Feedback -->
              <div id="detailed-feedback-<%= q._id %>" class="mt-2" style="display: none;">
                <div class="feedback-details">
                  <h6>Detailed Feedback:</h6>
                  <ul id="feedback-list-<%= q._id %>" class="mb-2"></ul>
                  <div class="keyword-analysis">
                    <small><strong>Matched Concepts:</strong> <span id="matched-<%= q._id %>"></span></small><br>
                    <small><strong>Missing Concepts:</strong> <span id="missing-<%= q._id %>"></span></small>
                  </div>
                </div>
              </div>
              
              <!-- Sample Answer Area -->
              <div id="sample-<%= q._id %>" class="mt-2" style="display:none;"></div>
            </div>
          <% }) %>
        </div>
      <% } else { %>
        <div class="no-questions">
          <i class="bi bi-inboxes"></i>
          <h5>No Practice Questions Available</h5>
          <p class="opacity-90">We're working on adding questions for this topic. Check back soon!</p>
        </div>
      <% } %>
      
      <div class="text-center mt-4">
        <a href="/practice?role=<%= selectedRole %>" class="btn btn-primary-custom">
          <i class="bi bi-arrow-left me-2"></i> Back to Topics
        </a>
      </div>
    </div>
  </div>

  <script>
    // Speech Recognition Setup - CORRECTED VERSION
    let recognition = null;
    let currentQuestionId = null;
    let isRecording = false;
    let hasMicrophoneAccess = false;

    // Test microphone access
    async function testMicrophoneAccess() {
      try {
        // Test if we can access microphone
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        // Immediately stop the stream - we just needed permission
        stream.getTracks().forEach(track => track.stop());
        hasMicrophoneAccess = true;
        console.log('Microphone access granted');
        hidePermissionWarning();
        return true;
      } catch (error) {
        console.error('Microphone access denied:', error);
        hasMicrophoneAccess = false;
        showPermissionWarning();
        return false;
      }
    }

    function showPermissionWarning() {
      document.getElementById('permissionWarning').style.display = 'block';
      disableAllVoiceButtons('Microphone access required');
    }

    function hidePermissionWarning() {
      document.getElementById('permissionWarning').style.display = 'none';
    }

    function showPermissionHelp() {
      alert(`To enable microphone access:\n\n1. Click the lock icon (ðŸ”’) in your browser's address bar\n2. Find "Microphone" in the list\n3. Change from "Block" to "Allow"\n4. Refresh the page and try again`);
    }

    function disableAllVoiceButtons(message) {
      document.querySelectorAll('.btn-voice').forEach(btn => {
        btn.disabled = true;
        btn.innerHTML = `<i class="bi bi-mic-mute me-1"></i> ${message}`;
      });
    }

    function updateStatus(questionId, message, type = 'info') {
      const statusElement = document.getElementById(`status-${questionId}`);
      statusElement.innerHTML = message;
      statusElement.className = 'voice-status';
      
      if (type === 'error') {
        statusElement.classList.add('status-error');
      } else if (type === 'success') {
        statusElement.classList.add('status-success');
      } else if (type === 'warning') {
        statusElement.classList.add('status-warning');
      }
    }

    function initializeSpeechRecognition() {
      // Check if browser supports speech recognition
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        console.warn('Speech recognition not supported in this browser');
        disableAllVoiceButtons('Voice not supported');
        return false;
      }

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      
      try {
        recognition = new SpeechRecognition();
        
        // Configure recognition
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = 'en-US';
        recognition.maxAlternatives = 1;

        recognition.onstart = function() {
          console.log('Speech recognition started');
          if (currentQuestionId) {
            updateStatus(currentQuestionId, '<i class="bi bi-mic-fill me-1"></i>Listening... Speak now!', 'success');
          }
        };

        recognition.onresult = function(event) {
          console.log('Speech detected');
          let finalTranscript = '';
          let interimTranscript = '';

          for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
              finalTranscript += transcript;
            } else {
              interimTranscript += transcript;
            }
          }

          if (currentQuestionId) {
            const textarea = document.getElementById(`answer-${currentQuestionId}`);
            // Update with the latest transcript
            const newText = finalTranscript || interimTranscript;
            if (newText.trim()) {
              textarea.value = newText;
              updateStatus(currentQuestionId, '<i class="bi bi-check-circle me-1"></i>Speech detected!', 'success');
            }
          }
        };

        recognition.onerror = function(event) {
          console.error('Speech recognition error:', event.error);
          
          if (currentQuestionId) {
            let errorMessage = 'Error with speech recognition';
            
            switch(event.error) {
              case 'no-speech':
                errorMessage = 'No speech detected. Please speak clearly into your microphone.';
                break;
              case 'audio-capture':
                errorMessage = 'No microphone found. Please check your microphone.';
                break;
              case 'not-allowed':
                errorMessage = 'Microphone permission denied. Please allow microphone access.';
                showPermissionWarning();
                break;
              default:
                errorMessage = `Error: ${event.error}`;
            }
            
            updateStatus(currentQuestionId, `<i class="bi bi-exclamation-triangle me-1"></i>${errorMessage}`, 'error');
          }
          
          stopRecording();
        };

        recognition.onend = function() {
          console.log('Speech recognition ended');
          if (isRecording && currentQuestionId) {
            // Auto-restart if still recording
            setTimeout(() => {
              if (isRecording && recognition) {
                try {
                  recognition.start();
                } catch (error) {
                  console.error('Failed to restart recognition:', error);
                  stopRecording();
                }
              }
            }, 100);
          }
        };

        return true;
        
      } catch (error) {
        console.error('Failed to initialize speech recognition:', error);
        disableAllVoiceButtons('Voice initialization failed');
        return false;
      }
    }

    async function startRecording(questionId) {
      console.log('Starting recording for:', questionId);
      
      // Stop any existing recording
      if (isRecording && recognition) {
        stopRecording(currentQuestionId);
        await new Promise(resolve => setTimeout(resolve, 500));
      }

      // Check microphone access first
      if (!hasMicrophoneAccess) {
        const hasAccess = await testMicrophoneAccess();
        if (!hasAccess) {
          updateStatus(questionId, '<i class="bi bi-exclamation-triangle me-1"></i>Microphone access required', 'error');
          return;
        }
      }

      // Initialize speech recognition if not already done
      if (!recognition) {
        const initialized = initializeSpeechRecognition();
        if (!initialized) {
          return;
        }
      }

      if (recognition && !isRecording) {
        currentQuestionId = questionId;
        isRecording = true;
        
        // Update UI
        const recordBtn = document.getElementById(`record-${questionId}`);
        const stopBtn = document.getElementById(`stop-${questionId}`);
        const textarea = document.getElementById(`answer-${questionId}`);
        
        recordBtn.style.display = 'none';
        stopBtn.style.display = 'inline-block';
        updateStatus(questionId, '<i class="bi bi-hourglass-split me-1"></i>Starting recording...', 'warning');
        
        textarea.placeholder = 'Listening... Speak your answer now';
        textarea.value = ''; // Clear previous answer
        recordBtn.classList.add('recording');
        
        try {
          await recognition.start();
        } catch (error) {
          console.error('Failed to start recording:', error);
          updateStatus(questionId, '<i class="bi bi-exclamation-triangle me-1"></i>Failed to start recording', 'error');
          stopRecording(questionId);
        }
      }
    }

    function stopRecording(questionId) {
      console.log('Stopping recording');
      
      if (isRecording) {
        isRecording = false;
        
        // Stop recognition
        if (recognition) {
          try {
            recognition.stop();
          } catch (error) {
            console.error('Error stopping recognition:', error);
          }
        }
        
        // Update UI
        if (questionId) {
          const recordBtn = document.getElementById(`record-${questionId}`);
          const stopBtn = document.getElementById(`stop-${questionId}`);
          const textarea = document.getElementById(`answer-${questionId}`);
          
          recordBtn.style.display = 'inline-block';
          stopBtn.style.display = 'none';
          
          const hasAnswer = textarea.value.trim() !== '';
          if (hasAnswer) {
            updateStatus(questionId, '<i class="bi bi-check-circle me-1"></i>Recording complete!', 'success');
          } else {
            updateStatus(questionId, '<i class="bi bi-info-circle me-1"></i>Ready to record', 'info');
          }
          
          textarea.placeholder = 'Type your answer here or use voice recording...';
          recordBtn.classList.remove('recording');
        }
        
        currentQuestionId = null;
      }
    }

    // Keep your existing functions (they're fine)
    async function tryYourself(id) {
      const userAnswer = document.getElementById('answer-' + id).value.trim();
      const feedback = document.getElementById('feedback-' + id);
      
      if (!userAnswer) {
        feedback.innerHTML = '<div class="feedback-box feedback-poor">Please provide an answer first.</div>';
        return;
      }

      feedback.innerHTML = '<div class="feedback-box">Analyzing your answer...</div>';

      try {
        const res = await fetch(`/api/questions/${id}/check`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userAnswer })
        });
        
        const data = await res.json();

        if (data.success) {
          let feedbackClass = 'feedback-average';
          if (data.percent >= 80) feedbackClass = 'feedback-good';
          else if (data.percent < 60) feedbackClass = 'feedback-poor';

          feedback.innerHTML = `
            <div class="feedback-box ${feedbackClass}">
              <strong>${data.feedback}</strong><br>
              <small>Score: ${data.percent}%</small>
            </div>
          `;
        }
      } catch (error) {
        feedback.innerHTML = '<div class="feedback-box feedback-poor">Error checking answer</div>';
      }
    }

    async function showSample(id) {
      const sampleDiv = document.getElementById('sample-' + id);
      
      if (sampleDiv.style.display === "block") {
        sampleDiv.style.display = "none";
        return;
      }

      sampleDiv.innerHTML = "<div class='feedback-box'>Loading...</div>";
      sampleDiv.style.display = "block";

      try {
        const res = await fetch(`/api/questions/${id}/answer`);
        const data = await res.json();
        sampleDiv.innerHTML = `<div class="feedback-box feedback-good"><strong>Sample Answer:</strong><br>${data.sampleAnswer || "No sample available"}</div>`;
      } catch (error) {
        sampleDiv.innerHTML = '<div class="feedback-box feedback-poor">Error loading sample</div>';
      }
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
      // Test microphone access on page load
      testMicrophoneAccess();
      
      // Initialize speech recognition
      initializeSpeechRecognition();

      // Your existing animation code
      const questions = document.querySelectorAll('.sample-question');
      questions.forEach(question => {
        const delay = question.getAttribute('data-delay') || 0;
        setTimeout(() => question.classList.add('visible'), parseInt(delay) + 500);
      });
    });

    // Cleanup
    window.addEventListener('beforeunload', function() {
      if (isRecording) {
        stopRecording(currentQuestionId);
      }
    });
  </script>
</body>
</html>