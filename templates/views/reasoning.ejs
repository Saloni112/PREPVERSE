<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Placement Prep - Logical Reasoning</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <style>
       :root {
            --primary: #1070AE;
            --primary-light: #439FC8;
            --primary-dark: #05243B;
            --secondary: #064471;
            --light: #F3EDE1;
            --dark: #05243B;
            --darker: #041A2E;
            --gray: #7e7e7e;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
        }

        body {
            background: #05243B;
            color: #F3EDE1;
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
        }

        
         /* Navbar Styling */
        .top-nav {
            background-color: var(--primary-dark);
            color: white;
            padding: 0.8rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            font-size: 1.5rem;
            font-weight: 600;
            color: white;
            text-decoration: none;
        }

        .logo img {
            width: 40px;
            margin-right: 10px;
        }

        .nav-menu {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
            gap: 1.5rem;
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.6) !important;
            text-decoration: none;
            padding: 0.5rem 0;
            position: relative;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav-link:hover {
            color: rgba(255, 255, 255, 0.9) !important;
        }

        .nav-link.active {
            color: white !important;
        }

        .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: var(--primary-light);
            border-radius: 3px 3px 0 0;
        }

        .user-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 15px;
            color: white;
        }

        .logout-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .logout-btn:hover {
            background-color: var(--primary-light);
        }

        .info-box {
            background: linear-gradient(135deg, var(--secondary), var(--primary-dark));
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .aptitude-heading {
            color: var(--light);
            margin: 2rem 0;
        }
        
        .aptitude-card {
            background: linear-gradient(135deg, var(--secondary), var(--primary-dark));
            border: 1px solid var(--primary-light);
            border-radius: 12px;
            color: var(--light);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .aptitude-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }
        
        .aptitude-card .card-body {
            padding: 1.5rem;
        }
        
        .aptitude-card .icon {
            display: inline-block;
            padding: 15px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .btn-outline-primary {
            color: var(--primary-light);
            border-color: var(--primary-light);
        }
        
        .btn-outline-primary:hover {
            background-color: var(--primary-light);
            border-color: var(--primary-light);
            color: var(--dark);
        }
        
        .text-theme-secondary {
            color: var(--primary-light) !important;
        }

        /* Question Container Styles */
        .question-container {
            background: linear-gradient(135deg, var(--secondary), var(--primary-dark));
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .question-card {
            color: var(--light);
        }

        .question-text {
            color: var(--light);
            font-weight: 500;
            line-height: 1.6;
            font-size: 1.2rem;
        }

        /* Options Styles */
        .options-container {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            margin: 2rem 0;
        }

        .option-item {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .option-item:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--primary-light);
        }

        .option-item.selected {
            background: rgba(16, 112, 174, 0.3);
            border-color: var(--primary-light);
        }

        .option-item.correct {
            background: rgba(40, 167, 69, 0.3);
            border-color: var(--success);
        }

        .option-item.incorrect {
            background: rgba(220, 53, 69, 0.3);
            border-color: var(--danger);
        }

        .option-letter {
            background: var(--primary);
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1rem;
        }

        .option-text {
            flex: 1;
            color: var(--light);
            font-size: 1.1rem;
        }

        /* Progress Bar */
        .progress-container {
            background: var(--darker);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 2rem;
        }

        .progress {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
        }

        .progress-bar {
            background: var(--primary-light);
            transition: width 0.3s ease;
        }

        /* Explanation Card */
        .explanation-card {
            border-radius: 8px;
            animation: fadeIn 0.5s ease;
            margin-top: 1.5rem;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Topic Cards */
        .qa-topic-card {
            background: linear-gradient(135deg, var(--secondary), var(--primary-dark)) !important;
            border: 1px solid var(--primary-light) !important;
            color: var(--light) !important;
            transition: all 0.3s ease !important;
            cursor: pointer;
        }

        .qa-topic-card:hover {
            transform: translateY(-5px) !important;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3) !important;
            border-color: var(--primary) !important;
        }

        .qa-topic-icon {
            font-size: 2rem;
            color: var(--primary-light);
            margin-bottom: 0.5rem;
        }

        .qa-topic-title {
            font-weight: 600;
            color: var(--light);
            font-size: 1.1rem;
        }

        .difficulty-badge {
            font-size: 0.8rem;
            padding: 0.3rem 0.8rem;
        }

        /* New Styles for Enhanced Features */
        .topic-progress {
            font-size: 0.8rem;
            color: var(--primary-light);
            margin-top: 0.5rem;
        }

        .completion-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--success);
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
        }

        .timer-container {
            background: var(--darker);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            margin-bottom: 1rem;
        }

        .topic-stats {
            font-size: 0.9rem;
            color: var(--primary-light);
        }

        /* Reasoning-specific styles */
        .puzzle-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .arrangement-diagram {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            text-align: center;
        }
        
        /* Timer warning styles */
        .timer-warning {
            color: var(--danger);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Final Submit Button */
        .final-submit-btn {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border: none;
            color: white;
            font-weight: 600;
            padding: 0.8rem 2rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .final-submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .final-submit-btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Performance Meter */
        .performance-meter {
            width: 150px;
            height: 150px;
            margin: 0 auto;
            position: relative;
        }
        
        .performance-circle {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(var(--primary-light) 0%, transparent 0%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .performance-inner {
            width: 80%;
            height: 80%;
            border-radius: 50%;
            background: var(--darker);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        .performance-score {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--light);
        }
        
        .performance-label {
            font-size: 0.8rem;
            color: var(--primary-light);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .stat-item {
            text-align: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-light);
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: var(--light);
        }
    </style>
</head> 
<body>
    <!-- Navigation -->
    <nav class="top-nav">
        <div class="nav-container">
            <a href="#" class="logo">
                <img src="/images/logo.png" alt="PrepVerse Logo">
                PrepVerse
            </a>
            <ul class="nav-menu" id="navMenu" style="margin-right: 150px;">
                <li><a href="/aptitude" class="nav-link">Home</a></li>
                <li><a href="/quant" class="nav-link">Quant</a></li>
                <li><a href="/reasoning" class="nav-link">Reasoning</a></li>
                <li><a href="/verbal" class="nav-link active">Verbal</a></li>
                <li><a href="/sdashboard" class="nav-link "><i class="fas fa-home"></i> Dashboard</a></li>

            </ul>
            
            <div class="user-actions" id="userActions">
                <div class="user-profile">
                </div>
            </div>
        </div>
    </nav>


    <div class="main-bg min-vh-100 py-5">
        <div class="container">
            <!-- Hero Section -->
            <div class="text-center mb-5">
                <div class="display-4 mb-2" style="color:#1070AE;">
                    <i class="fa-solid fa-gears"></i>
                </div>
                <h1 class="fw-bold" style="color: #e6e6e6;">Logical Reasoning</h1>
                <p class="lead" style="color:#439FC8;">
                    "Logic will get you from A to B. Imagination will take you everywhere." <br>
                    <span class="fst-italic" style="color:#064471;">â€“ Albert Einstein</span>
                </p>
            </div>

            <!-- Motivational Quote -->
            <div class="alert alert-info text-center mb-4" style="background:#1070AE;color:#fff;border:none;">
                <i class="fa-solid fa-lightbulb me-2"></i>
                Enhance your thinking skills and tackle any reasoning challenge with confidence!
            </div>

            <!-- Timer Section -->
            <div id="timerSection" class="timer-container text-center" style="display: none;">
                <span class="fw-bold text-theme-secondary">
                    <i class="fas fa-clock me-2"></i>
                    Time: <span id="timer">00:60</span>
                </span>
            </div>

            <!-- Progress Section (Initially Hidden) -->
            <div id="progressSection" class="progress-container" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span id="scoreText" class="fw-bold text-theme-secondary">Score: 0/0</span>
                    <span id="progressText" class="text-muted">0/0</span>
                </div>
                <div class="progress">
                    <div id="progressBar" class="progress-bar" style="width: 0%"></div>
                </div>
            </div>

            <!-- Question Container -->
            <div id="questionContainer" class="question-container">
                <div class="text-center py-5">
                    <h4>Select a topic to start practicing!</h4>
                    <p class="text-muted">Choose from the topics below to begin your reasoning practice.</p>
                </div>
            </div>

            <!-- Final Submit Button (Initially Hidden) -->
            <div id="finalSubmitSection" class="text-center mb-4" style="display: none;">
                <button class="btn final-submit-btn" onclick="submitTest()">
                    <i class="fas fa-paper-plane me-2"></i> Submit Test
                </button>
            </div>

            <!-- Topics as Cards -->
            <div class="d-flex flex-row flex-nowrap overflow-auto qa-topic-badges mb-4 gap-3 px-1">
                <a href="javascript:void(0)" onclick="loadTopic('number-series')" class="text-decoration-none text-reset">
                    <div class="card text-center shadow-sm qa-topic-card position-relative" style="min-width:210px; max-width:210px; min-height:180px; max-height:180px;">
                        <div class="card-body py-3 d-flex flex-column justify-content-center align-items-center" style="height:140px;">
                            <span class="qa-topic-icon"><i class="fa-solid fa-puzzle-piece"></i></span>
                            <div class="qa-topic-title mt-2">Number Series</div>
                        </div>
                    </div>
                </a>
                <a href="javascript:void(0)" onclick="loadTopic('seating-arrangement')" class="text-decoration-none text-reset">
                    <div class="card text-center shadow-sm qa-topic-card position-relative" style="min-width:210px; max-width:210px; min-height:180px; max-height:180px;">
                        <div class="card-body py-3 d-flex flex-column justify-content-center align-items-center" style="height:140px;">
                            <span class="qa-topic-icon"><i class="fa-solid fa-layer-group"></i></span>
                            <div class="qa-topic-title mt-2">Seating Arrangement</div>
                        </div>
                    </div>
                </a>
                <a href="javascript:void(0)" onclick="loadTopic('blood-relations')" class="text-decoration-none text-reset">
                    <div class="card text-center shadow-sm qa-topic-card position-relative" style="min-width:210px; max-width:210px; min-height:180px; max-height:180px;">
                        <div class="card-body py-3 d-flex flex-column justify-content-center align-items-center" style="height:140px;">
                            <span class="qa-topic-icon"><i class="fa-solid fa-people-arrows"></i></span>
                            <div class="qa-topic-title mt-2">Blood Relations</div>
                        </div>
                    </div>
                </a>
                <a href="javascript:void(0)" onclick="loadTopic('syllogism')" class="text-decoration-none text-reset">
                    <div class="card text-center shadow-sm qa-topic-card position-relative" style="min-width:210px; max-width:210px; min-height:180px; max-height:180px;">
                        <div class="card-body py-3 d-flex flex-column justify-content-center align-items-center" style="height:140px;">
                            <span class="qa-topic-icon"><i class="fa-solid fa-diagram-project"></i></span>
                            <div class="qa-topic-title mt-2">Syllogism</div>
                        </div>
                    </div>
                </a>
            </div>
        </div>
    </div>

    <!-- Performance Modal -->
    <div class="modal fade" id="performanceModal" tabindex="-1" aria-labelledby="performanceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="background: linear-gradient(135deg, var(--secondary), var(--primary-dark)); border: 1px solid var(--primary-light); color: var(--light);">
                <div class="modal-header">
                    <h5 class="modal-title" id="performanceModalLabel">Test Results</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="performance-meter mb-4">
                        <div class="performance-circle" id="performanceCircle">
                            <div class="performance-inner">
                                <div class="performance-score" id="performanceScore">0%</div>
                                <div class="performance-label">Score</div>
                            </div>
                        </div>
                    </div>
                    
                    <h4 class="mb-3">Test Completed Successfully!</h4>
                    
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="correctAnswers">0</div>
                            <div class="stat-label">Correct</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="totalQuestions">0</div>
                            <div class="stat-label">Total</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="timeTaken">0:00</div>
                            <div class="stat-label">Time</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="accuracy">0%</div>
                            <div class="stat-label">Accuracy</div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <p id="performanceMessage" class="mb-0">Keep practicing to improve your score!</p>
                    </div>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-primary" onclick="showTopics()" data-bs-dismiss="modal">
                        <i class="fas fa-list me-2"></i>Try Another Topic
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="loadTopic(currentTopic)" data-bs-dismiss="modal">
                        <i class="fas fa-redo me-2"></i>Retry This Topic
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Global variables
        let currentTopic = '';
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let userScore = 0;
        let selectedOptionIndex = -1;
        let timerInterval;
        let timeLeft = 60; // 60 seconds per question
        let userProgress = {};
        let totalTimeSpent = 0;
        let testStartTime = 0;
        let userAnswers = [];
        let currentUserEmail = '';
        let testTimeElapsed = 0;
        let testTimerInterval;

        // Function to load questions for a topic
        async function loadTopic(topicSlug) {
            try {
                showLoading();
                
                // Try multiple API endpoint variations for reasoning questions
                const endpoints = [
                    `/api/questions/reasoning/${topicSlug}`,
                    `/api/reasoning/questions/${topicSlug}`,
                    `/api/questions?topic=${topicSlug}&category=reasoning`,
                    `/api/questions/topic/${topicSlug}`
                ];

                let response = null;
                let data = null;

                // Try each endpoint until one works
                for (const endpoint of endpoints) {
                    try {
                        console.log(`Trying endpoint: ${endpoint}`);
                        response = await fetch(endpoint);
                        
                        if (response.ok) {
                            data = await response.json();
                            console.log('Success with endpoint:', endpoint);
                            console.log('API Response:', data);
                            break;
                        }
                    } catch (err) {
                        console.log(`Failed with endpoint ${endpoint}:`, err.message);
                        continue;
                    }
                }

                if (!response || !response.ok) {
                    throw new Error(`All endpoints failed. Last status: ${response ? response.status : 'No response'}`);
                }

                // Handle different response structures
                if (data.success && data.questions) {
                    currentQuestions = data.questions;
                } else if (Array.isArray(data)) {
                    currentQuestions = data;
                } else if (data.data && Array.isArray(data.data)) {
                    currentQuestions = data.data;
                } else {
                    throw new Error('Invalid response format: questions array not found');
                }

                // Check if we got questions
                if (currentQuestions.length === 0) {
                    document.getElementById('questionContainer').innerHTML = `
                        <div class="alert alert-warning text-center">
                            <h4>No questions available</h4>
                            <p>No questions found for ${topicSlug} in the database.</p>
                            <button class="btn btn-primary mt-2" onclick="showTopics()">Back to Topics</button>
                        </div>
                    `;
                    hideLoading();
                    return;
                }

                currentTopic = topicSlug;
                currentQuestionIndex = 0;
                userScore = 0;
                selectedOptionIndex = -1;
                timeLeft = 60;
                userAnswers = new Array(currentQuestions.length).fill(null);
                testTimeElapsed = 0;
                
                // Show progress and timer sections
                document.getElementById('progressSection').style.display = 'block';
                document.getElementById('timerSection').style.display = 'block';
                document.getElementById('finalSubmitSection').style.display = 'block';
                
                // Start timers
                startTimer();
                startTestTimer();
                
                showQuestion();
                updateProgress();
                
                // Update topic progress display with real data
                updateTopicProgressDisplay(topicSlug, currentQuestions.length);
                
                hideLoading();
                
            } catch (error) {
                console.error('Error loading questions:', error);
                document.getElementById('questionContainer').innerHTML = `
                    <div class="alert alert-danger text-center">
                        <h4>Error Loading Questions</h4>
                        <p>${error.message}</p>
                        <div class="mt-3">
                            <button class="btn btn-primary me-2" onclick="loadTopic('${topicSlug}')">Retry</button>
                            <button class="btn btn-outline-primary" onclick="showTopics()">Back to Topics</button>
                        </div>
                    </div>
                `;
                hideLoading();
            }
        }

        // Update topic progress display with real question counts
        function updateTopicProgressDisplay(topicSlug, totalQuestions) {
            const progressElement = document.getElementById(`${topicSlug}-progress`);
            if (progressElement) {
                const completed = userProgress[topicSlug] ? userProgress[topicSlug].completed : 0;
                progressElement.textContent = `${completed}/${totalQuestions} completed`;
            }
        }

        // Timer functions
        function startTimer() {
            clearInterval(timerInterval);
            timeLeft = 60;
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    // Auto-submit current question and move to next
                    autoSubmitAndMoveToNext();
                } else if (timeLeft <= 10) {
                    // Add warning style when time is running low
                    document.getElementById('timer').classList.add('timer-warning');
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('timer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function stopTimer() {
            clearInterval(timerInterval);
            document.getElementById('timer').classList.remove('timer-warning');
        }

        // Test timer functions
        function startTestTimer() {
            clearInterval(testTimerInterval);
            testTimeElapsed = 0;
            testTimerInterval = setInterval(() => {
                testTimeElapsed++;
            }, 1000);
        }

        function stopTestTimer() {
            clearInterval(testTimerInterval);
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        // Function to auto-submit and move to next question
        function autoSubmitAndMoveToNext() {
            const question = currentQuestions[currentQuestionIndex];
            
            // If no option was selected, mark as incorrect
            if (selectedOptionIndex === -1) {
                userAnswers[currentQuestionIndex] = {
                    selected: null,
                    correct: false
                };
            } else {
                // Check if the selected answer is correct
                const isCorrect = question.options[selectedOptionIndex] === question.answer;
                userAnswers[currentQuestionIndex] = {
                    selected: question.options[selectedOptionIndex],
                    correct: isCorrect
                };
                
                if (isCorrect) {
                    userScore++;
                }
            }
            
            // Move to next question or show completion
            if (currentQuestionIndex < currentQuestions.length - 1) {
                currentQuestionIndex++;
                selectedOptionIndex = -1;
                startTimer();
                showQuestion();
            } else {
                // All questions answered, enable submit button
                document.querySelector('.final-submit-btn').disabled = false;
                submitTest();
            }
            
            updateProgress();
        }

        // Function to display current question
        function showQuestion() {
            if (currentQuestions.length === 0) {
                document.getElementById('questionContainer').innerHTML = `
                    <div class="alert alert-info text-center">
                        <h4>No questions available for this topic</h4>
                        <p>Please check back later or try another topic.</p>
                    </div>
                `;
                hideLoading();
                return;
            }

            const question = currentQuestions[currentQuestionIndex];
            
            // Validate question structure
            if (!question.question || !question.options || !Array.isArray(question.options)) {
                console.error('Invalid question structure:', question);
                document.getElementById('questionContainer').innerHTML = `
                    <div class="alert alert-danger text-center">
                        <h4>Invalid Question Format</h4>
                        <p>The question data is not in the expected format.</p>
                        <button class="btn btn-primary mt-2" onclick="nextQuestion()">Skip Question</button>
                    </div>
                `;
                hideLoading();
                return;
            }
            
            // Add reasoning-specific content based on topic
            let reasoningContent = '';
            if (currentTopic.includes('arrangement')) {
                reasoningContent = `
                    <div class="arrangement-diagram">
                        <i class="fas fa-chair fa-2x mb-2"></i>
                        <p class="mb-0">Visualize the seating arrangement before answering</p>
                    </div>
                `;
            } else if (currentTopic.includes('series')) {
                reasoningContent = `
                    <div class="puzzle-container">
                        <p class="mb-2"><strong>Pattern Hint:</strong> Look for arithmetic, geometric, or alternating patterns</p>
                    </div>
                `;
            }
            
            const questionHTML = `
                <div class="question-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="badge difficulty-badge bg-${getDifficultyBadge(question.difficulty || 'medium')}">
                            ${(question.difficulty || 'medium').toUpperCase()}
                        </span>
                        <span class="text-muted">Question ${currentQuestionIndex + 1} of ${currentQuestions.length}</span>
                    </div>
                    
                    <h4 class="question-text mb-4">${question.question}</h4>
                    
                    ${reasoningContent}
                    
                    ${question.image ? `<div class="text-center mb-4"><img src="${question.image}" alt="Question Image" class="img-fluid" style="max-height: 200px;"></div>` : ''}
                    
                    <div class="options-container">
                        ${question.options.map((option, index) => `
                            <div class="option-item" onclick="selectOption(${index})" id="option-${index}">
                                <span class="option-letter">${String.fromCharCode(65 + index)}</span>
                                <span class="option-text">${option}</span>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="mt-4 d-flex justify-content-between">
                        <button class="btn btn-outline-secondary" onclick="previousQuestion()" 
                            ${currentQuestionIndex === 0 ? 'disabled' : ''}>
                            <i class="fas fa-arrow-left"></i> Previous
                        </button>
                        <button class="btn btn-outline-primary" onclick="nextQuestion()" 
                            ${currentQuestionIndex === currentQuestions.length - 1 ? 'disabled' : ''}>
                            Next <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('questionContainer').innerHTML = questionHTML;
            resetOptionSelection();
            hideLoading();
        }

        // Function to select an option
        function selectOption(optionIndex) {
            resetOptionSelection();
            selectedOptionIndex = optionIndex;
            const optionElement = document.getElementById(`option-${optionIndex}`);
            optionElement.classList.add('selected');
            
            // Auto-submit the answer after selection
            checkAnswer();
        }

        // Function to reset option selection
        function resetOptionSelection() {
            document.querySelectorAll('.option-item').forEach(option => {
                option.classList.remove('selected');
            });
            selectedOptionIndex = -1;
        }

        // Function to check answer
        function checkAnswer() {
            if (selectedOptionIndex === -1) {
                return;
            }

            const question = currentQuestions[currentQuestionIndex];
            
            // Handle different answer field names
            const correctAnswer = question.answer || question.correctAnswer || question.correct_option;
            const userAnswer = question.options[selectedOptionIndex];
            
            const isCorrect = userAnswer === correctAnswer;

            // Show result immediately
            showAnswerResult(isCorrect, question);
            
            // Store the answer
            userAnswers[currentQuestionIndex] = {
                selected: question.options[selectedOptionIndex],
                correct: isCorrect
            };
            
            // Update score
            if (isCorrect) {
                userScore++;
            }
            
            // Save progress for this question
            saveProgress(currentTopic, currentQuestionIndex, isCorrect);
            
            // Stop timer since answer was submitted
            stopTimer();
            
            updateProgress();
        }

        // Function to show answer result
        function showAnswerResult(isCorrect, question) {
            const options = document.querySelectorAll('.option-item');
            
            // Handle different answer field names
            const correctAnswer = question.answer || question.correctAnswer || question.correct_option;
            
            options.forEach((option, index) => {
                option.style.pointerEvents = 'none'; // Disable further clicks
                
                if (question.options[index] === correctAnswer) {
                    option.classList.add('correct');
                } else if (index === selectedOptionIndex && !isCorrect) {
                    option.classList.add('incorrect');
                }
            });

            // Handle different explanation field names
            const explanation = question.explanation || question.solution || 'No explanation available.';
            
            // Show explanation
            const explanationHTML = `
                <div class="explanation-card ${isCorrect ? 'bg-success' : 'bg-danger'} text-white">
                    <div class="card-body">
                        <h5><i class="fas ${isCorrect ? 'fa-check' : 'fa-times'} me-2"></i>
                            ${isCorrect ? 'Correct!' : 'Incorrect!'}
                        </h5>
                        <p class="mb-0"><strong>Explanation:</strong> ${explanation}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('questionContainer').insertAdjacentHTML('beforeend', explanationHTML);
        }

        // Function to navigate to next question
        function nextQuestion() {
            stopTimer();
            
            if (currentQuestionIndex < currentQuestions.length - 1) {
                currentQuestionIndex++;
                selectedOptionIndex = -1;
                startTimer();
                showQuestion();
            } else {
                // Quiz completed
                submitTest();
            }
        }

        // Function to navigate to previous question
        function previousQuestion() {
            stopTimer();
            
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                selectedOptionIndex = -1;
                startTimer();
                showQuestion();
            }
        }

        // Function to save progress
        function saveProgress(topic, questionIndex, isCorrect) {
            if (!userProgress[topic]) {
                userProgress[topic] = {
                    completed: 0,
                    correct: 0,
                    total: currentQuestions.length
                };
            }
            
            userProgress[topic].completed = Math.max(userProgress[topic].completed, questionIndex + 1);
            if (isCorrect) {
                userProgress[topic].correct++;
            }
            
            // Update topic progress display
            updateTopicProgress();
            
            // Save to localStorage with user-specific key
            const userEmail = document.getElementById('userEmail').textContent;
            const userKey = `reasoningProgress_${userEmail}`;
            localStorage.setItem(userKey, JSON.stringify(userProgress));
        }

        // Function to update topic progress display
        function updateTopicProgress() {
            document.querySelectorAll('.topic-progress').forEach(element => {
                const topicName = element.closest('.qa-topic-card').querySelector('.qa-topic-title').textContent.toLowerCase().replace(' ', '-');
                if (userProgress[topicName]) {
                    element.textContent = `${userProgress[topicName].completed}/${userProgress[topicName].total} completed`;
                }
            });
        }

        // Function to calculate final score based on saved answers
        function calculateFinalScore() {
            userScore = 0;
            userAnswers.forEach((answer, index) => {
                if (answer && answer.correct) {
                    userScore++;
                }
            });
            return userScore;
        }

        // Function to get performance level
        function getPerformanceLevel(percentage) {
            if (percentage >= 90) return 'Excellent';
            if (percentage >= 80) return 'Very Good';
            if (percentage >= 70) return 'Good';
            if (percentage >= 60) return 'Average';
            if (percentage >= 50) return 'Below Average';
            return 'Poor';
        }

        // Function to show topics list
        function showTopics() {
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('timerSection').style.display = 'none';
            document.getElementById('finalSubmitSection').style.display = 'none';
            document.getElementById('questionContainer').innerHTML = `
                <div class="text-center py-5">
                    <h4>Select a topic to start practicing!</h4>
                    <p class="text-muted">Choose from the topics below to begin your reasoning practice.</p>
                </div>
            `;
        }

        // Function to update progress
        function updateProgress() {
            const progress = ((currentQuestionIndex + 1) / currentQuestions.length) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('progressText').textContent = 
                `${currentQuestionIndex + 1}/${currentQuestions.length}`;
            document.getElementById('scoreText').textContent = `Score: ${userScore}/${currentQuestions.length}`;
        }

        // Function to get difficulty badge class
        function getDifficultyBadge(difficulty) {
            if (!difficulty) return 'secondary';
            
            switch (difficulty.toLowerCase()) {
                case 'easy': return 'success';
                case 'medium': return 'warning';
                case 'hard': return 'danger';
                default: return 'secondary';
            }
        }

        // Submit test function
        function submitTest() {
            stopTimer();
            stopTestTimer();
            
            // Calculate final score
            const finalScore = calculateFinalScore();
            const percentage = (finalScore / currentQuestions.length) * 100;
            
            // Update performance modal
            document.getElementById('correctAnswers').textContent = finalScore;
            document.getElementById('totalQuestions').textContent = currentQuestions.length;
            document.getElementById('timeTaken').textContent = formatTime(testTimeElapsed);
            document.getElementById('accuracy').textContent = `${percentage.toFixed(1)}%`;
            document.getElementById('performanceScore').textContent = `${percentage.toFixed(1)}%`;
            
            // Update performance circle
            const performanceCircle = document.getElementById('performanceCircle');
            performanceCircle.style.background = `conic-gradient(var(--primary-light) ${percentage}%, transparent ${percentage}%)`;
            
            // Update performance message
            const performanceMessage = document.getElementById('performanceMessage');
            performanceMessage.textContent = getPerformanceMessage(percentage);
            
            // Show the modal
            const performanceModal = new bootstrap.Modal(document.getElementById('performanceModal'));
            performanceModal.show();
            
            // Save progress for the entire test
            saveTestProgress(finalScore);
        }

        // Function to get performance message
        function getPerformanceMessage(percentage) {
            if (percentage >= 90) return 'Outstanding performance! You have mastered this topic.';
            if (percentage >= 80) return 'Excellent work! You have a strong understanding of this topic.';
            if (percentage >= 70) return 'Good job! You have a solid grasp of this topic.';
            if (percentage >= 60) return 'Not bad! With a bit more practice, you can improve further.';
            if (percentage >= 50) return 'You passed, but there is room for improvement. Keep practicing!';
            return 'Keep practicing! Review the concepts and try again.';
        }

        // Function to save test progress
        function saveTestProgress(finalScore) {
            if (!userProgress[currentTopic]) {
                userProgress[currentTopic] = {
                    completed: 0,
                    correct: 0,
                    total: currentQuestions.length
                };
            }
            
            userProgress[currentTopic].completed = currentQuestions.length;
            userProgress[currentTopic].correct = finalScore;
            
            // Update topic progress display
            updateTopicProgress();
            
            // Save to localStorage with user-specific key
            const userEmail = document.getElementById('userEmail').textContent;
            const userKey = `reasoningProgress_${userEmail}`;
            localStorage.setItem(userKey, JSON.stringify(userProgress));
        }

        // Loading functions
        function showLoading() {
            document.getElementById('questionContainer').innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Loading questions...</p>
                </div>
            `;
        }

        function hideLoading() {
            // Loading is hidden when content is shown
        }

        // Load user progress from localStorage
        function loadUserProgress() {
            const userEmail = document.getElementById('userEmail').textContent;
            const userKey = `reasoningProgress_${userEmail}`;
            const savedProgress = localStorage.getItem(userKey);
            if (savedProgress) {
                userProgress = JSON.parse(savedProgress);
                updateTopicProgress();
            }
        }

        // Check if we're on a topic page from URL
        document.addEventListener('DOMContentLoaded', function() {
            // Get user email (in a real app, this would come from authentication)
            // For demo purposes, we'll use a placeholder
            const userEmail = 'user@example.com'; // This would come from your auth system
            document.getElementById('userEmail').textContent = userEmail;
            
            loadUserProgress();
            
            const urlParams = new URLSearchParams(window.location.search);
            const topicSlug = urlParams.get('slug');
            
            if (topicSlug) {
                loadTopic(topicSlug);
            }
        });
    </script>
</body>
</html>